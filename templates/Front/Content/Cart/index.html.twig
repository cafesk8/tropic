{% extends 'Front/Layout/layoutWithoutPanel.html.twig' %}
{% import 'Front/Content/Product/productListMacro.html.twig' as productList %}
{% import 'Front/Inline/Product/distinguishingParameterMacro.html.twig' as distinguishingParameter %}

{% block meta_robots -%}
    <meta name="robots" content="noindex, follow">
{% endblock %}

{% block title %}
    {{ 'Cart'|trans }}
{% endblock %}

{% block breadcrumb %}
{% endblock %}

{% block flashMessage %}
{% endblock %}

{% block infoRow %}
{% endblock %}

{% block header %}
    {% set shopInfoPhoneNumber = getShopInfoPhoneNumber() %}
    {% set shopInfoPhoneHours = getShopInfoPhoneHours() %}

    <div class="web__container web__container--transparent">
        <header class="header header--small">
            <div class="header__logo">
                {% block logo %}
                    <a class="logo" href="{{ url('front_homepage') }}">
                        <img src="{{ asset('assets/frontend/images/logo-small.png') }}" alt="{{ 'Online shop'|trans }}">
                        <span class="logo__text">{{ 'Framework'|trans }}</span>
                    </a>
                {% endblock %}
            </div>
            <div class="header__contact dont-print">
                <div class="header__contact__phone">
                    <a href="tel:{{ shopInfoPhoneNumber }}">{{ shopInfoPhoneNumber }}</a>
                </div>
                <div class="header__contact__text">
                    {{ 'Ozvěte se nejlépe ve všední dny mezi'|trans }} {{ shopInfoPhoneHours }}.
                </div>
            </div>
        </header>
    </div>
{% endblock %}

{% block main_content %}
    <div class="web__line">
        <div class="web__container web__container--transparent">
            {% include 'Front/Inline/OrderProgress/index.html.twig' with {step: '1'} only %}
        </div>
    </div>

    <div class="web__line">
        <div class="web__container web__container--border-radius-top">
            <div class="box-order">
                <div class="box-order__message">
                    {{ render(controller('App\\Controller\\Front\\FlashMessageController:indexAction')) }}
                </div>
                {% if cart is not null %}
                    {{ form_start(form, { attr: { class: 'js-no-validate js-cart-form' }}) }}
                        <div class="box-order__wrap">
                            <div class="box-order__info">
                                {{ form_errors(form) }}
                                <div class="table-cart js-cart">
                                    {% for index, cartItem in cartItems %}
                                        {% set cartItemPrice = cartItemPrices[index] %}
                                        {% set cartItemUrl = url('front_product_detail', {id: cartItem.product.id}) %}
                                        <div class="table-cart__row js-cart-item">
                                            <div class="table-cart__row__left">
                                                <div class="table-cart__cell__number">
                                                    <span class="table-cart__cell__number__text">
                                                        {{ loop.index }}
                                                    </span>
                                                </div>
                                                <div class="table-cart__cell__image">
                                                    <a href="{{ cartItemUrl }}" title="{{ cartItem.product.name }}">
                                                        {{ image(cartItem.product.productForCreatingImageAccordingToVariant, { size: 'biggerThumbnail', lazy: true }) }}
                                                    </a>
                                                </div>
                                                <div class="table-cart__cell__name js-cart-item-name">
                                                    <a class="table-cart__cell__name__title" href="{{ cartItemUrl }}" title="{{ cartItem.name }}">
                                                        {{ cartItem.name }}
                                                    </a>
                                                    {{ distinguishingParameter.writeParameters(cartItem.product, 'table-cart__cell__name__text') }}
                                                </div>
                                            </div>
                                            <div class="table-cart__row__right">
                                                <div class="table-cart__cell__spinbox">
                                                    <span class="form-input-spinbox js-spinbox">
                                                        {{ form_widget(form.quantities[cartItem.id], { attr: {
                                                            class: 'form-input-spinbox__input input-no-style js-spinbox-input',
                                                            'data-spinbox-min': cartItem.product.realMinimumAmount,
                                                            'data-spinbox-step': cartItem.product.amountMultiplier
                                                        }}) }}
                                                        <div class="btn-no-style form-input-spinbox__btn js-spinbox-plus"><i class="svg svg-plus"></i></div>
                                                        <div class="btn-no-style form-input-spinbox__btn form-input-spinbox__btn--minus js-spinbox-minus"><i class="svg svg-minus"></i></div>
                                                    </span>
                                                    <a
                                                        href="{{ url('front_cart_delete', {cartItemId: cartItem.id, _token: csrf_token('front_cart_delete_' ~ cartItem.id)}) }}"
                                                        class="table-cart__cell__spinbox__link js-cart-item-remove-button"
                                                    >
                                                        {{ 'Odstranit'|trans }}
                                                    </a>
                                                </div>
                                                <div class="table-cart__cell__price js-cart-item-total-price">
                                                    {% if cartItemPrice.unitPrice.isActionPrice %}
                                                        <span class="table-cart__cell__price__line-through">{{ cartItemPrice.unitPrice.defaultProductPrice.priceWithVat|price }}</span>
                                                    {% endif %}
                                                    <div class="table-cart__cell__price__primary">
                                                        {{ cartItemPrice.unitPrice.priceWithVat|price }}
                                                    </div>
                                                    {% if promoCodesIndexedById is not empty %}
                                                        <div class="table-cart__cell__discount">
                                                            {% for promoCodeId, promoCode in promoCodesIndexedById %}
                                                                {% if cartItemDiscountsIndexedByPromoCodeId[promoCodeId][index] is not null %}
                                                                    &nbsp;{{ promoCode.code }}&nbsp;
                                                                    -{{ cartItemDiscountsIndexedByPromoCodeId[promoCodeId][index].priceWithVat|price }}
                                                                    <br>
                                                                {% endif %}
                                                            {% endfor %}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>

                                        {% if cartItem.product.id in cartGiftsByProductId|keys %}
                                            {% set cartItemGift = cartGiftsByProductId[cartItem.product.id] %}
                                            <div class="table-cart__gifts">
                                                {% for giftVariant in cartItemGift %}
                                                    <div class="table-cart__gifts__item">
                                                        {{ form_widget(form.chosenGifts[cartItem.product.id][giftVariant.gift.id], {
                                                            attr: {
                                                                class: 'css-checkbox js-take-gift',
                                                                'data-cart-product-id': cartItem.product.id
                                                            }
                                                        }) }}
                                                        <label class="css-checkbox__image" for="{{ form.chosenGifts[cartItem.product.id][giftVariant.gift.id].vars.id }}">
                                                            {{ 'Chceš dárek'|trans }}
                                                            {{ giftVariant.gift.name }}
                                                            {{ 'zdarma' }}
                                                            {{ 'v hodnotě'|trans }} {{ getProductSellingPrice(giftVariant.gift).priceWithVat|price }}{{ '?' }}                                                        </label>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            {% do form.chosenGifts.setRendered %}
                                        {% endif %}

                                    {% endfor %}
                                    {% if promoProducts|length > 0 %}
                                        <div class="table-cart__gifts--promo">
                                            <h3>{{ 'Promo produkty k objednávce'|trans }}</h3>
                                            {% for promoProductByPromoProductId in promoProducts %}
                                                {% for productId, promoProduct in promoProductByPromoProductId %}
                                                    <div class="table-cart__gifts__item">
                                                        {{ form_widget(form.chosenPromoProducts[promoProduct.id][productId], {
                                                            attr: {
                                                                class: 'css-checkbox js-cart-take-promo-product',
                                                                'data-cart-promo-product-id': promoProduct.id,
                                                                'data-cart-product-id': productId
                                                            }
                                                        }) }}
                                                        <label class="css-checkbox__image" for="{{ form.chosenPromoProducts[promoProduct.id][productId].vars.id }}">
                                                            {{ 'Chceš promo produkt'|trans }}
                                                            {{ getProductById(productId).name }}
                                                            {{ 'za zvýhodněnou cenu'|trans }} {{ promoProduct.price|price }}{{ '?' }}
                                                        </label>
                                                    </div>
                                                {% endfor %}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    {% do form.chosenPromoProducts.setRendered %}
                                </div>

                                {% if isFreeTransportAndPaymentActive %}
                                    {% if isPaymentAndTransportFree %}
                                        <div class="in-free-transport in-free-transport--dark">
                                            <span class="in-free-transport__title__important">{{ 'Máte dopravu zdarma!'|trans }}</span>
                                            <div class="in-free-transport__pipe">
                                                <div class="in-free-transport__pipe__line" style="width: 100%;"></div>
                                            </div>
                                        </div>
                                    {% else %}
                                        <div class="in-free-transport in-free-transport--dark">
                                            <div class="in-free-transport__title">
                                                {{ 'Nakupte ještě za '|trans }} <span class="in-free-transport__title__price">{{ remainingPriceWithVat|price }}</span>&nbsp;{{ 'a'|trans }} {{ 'máte'|trans }}
                                                <br> <span class="in-free-transport__title__important">{{ 'dopravu zdarma!'|trans }}</span>
                                            </div>
                                            <div class="in-free-transport__pipe">
                                                <div class="in-free-transport__pipe__line" style="width: {{ percentsForFreeTransportAndPayment }}%;"></div>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endif %}

                                <div class="box-order__additional">
                                    <div class="box-order__additional__title">
                                        {{ 'Přihoďte si k nákupu'|trans }}
                                    </div>
                                    {{ productList.horizontalList(topProducts, "list-basket-additionals", 'h3', 'basket-additionals', true) }}
                                </div>
                            </div>
                            <div id="js-order-preview" class="box-order__cart" data-url="{{ url('front_order_preview') }}">
                                {{ render(controller('App\\Controller\\Front\\OrderController:previewAction', {
                                    orderStep: "1",
                                    formSubmit: form.submit
                                })) }}
                            </div>
                        </div>
                    {{ form_end(form) }}
                {% else %}
                    <div class="box-cart-empty">
                        <div class="box-cart-empty__image">
                            <img src="{{ asset('assets/frontend/images/empty-cart.png') }}" alt="{{ 'Empty cart'|trans }}">
                        </div>
                        <div class="box-cart-empty__text">
                            {{ 'Your cart is unfortunately empty. To create order, you have to <a href="%url%">choose</a> some product first'|transHtml({ '%url%': url('front_homepage') }) }}

                            <div class="box-cart-empty__text__button">
                                <a href="{{url('front_homepage') }}" class="btn">
                                    {{ 'Back to buying'|trans }}
                                </a>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

{% endblock %}
