{% macro productPreviewItem(product, quantity, price, saleItem = false) %}
    <li class="list-cart-preview__item">
        <div class="list-cart-preview__item__image">
            {{ image(product.productForCreatingImageAccordingToVariant, { size: 'thumbnail' }) }}
        </div>
        <div class="list-cart-preview__item__pieces">
            {{ quantity|formatNumber }} {{ product.unit.name }}
        </div>
        <div class="list-cart-preview__item__info">
            <span class="list-cart-preview__item__title">
                {{ product.name }}
                {% if saleItem is same as (true) %}
                    {{ ' - Výprodej'|trans }}
                {% endif %}
            </span>
        </div>
        <div class="list-cart-preview__item__price">
            {{ price|priceText }}
        </div>
    </li>
{% endmacro %}


<div class="box-preview">   
    <div class="box-preview__content">
        {% if orderStep == "1" %}
            <div class="box-preview__item">
                {{ render(controller('App\\Controller\\Front\\PromoCodeController:indexAction')) }}
            </div>
        {% endif %}

        <div class="box-preview__item{% if orderStep == "1" %} box-preview__item--total{% endif %}">
            {% if orderStep > 1 %}
                <h2 class="in-title in-title--small in-title--dark">
                    {{ 'Vaše objednávka'|trans }}
                </h2>
                <ul id="js-order-preview-cart" class="list-cart-preview">
                    {% for quantifiedProductKey, quantifiedProduct in orderPreview.quantifiedProducts %}
                        {% set quantifiedProductPrice = orderPreview.quantifiedItemsPrices[quantifiedProductKey] %}
                        {{ _self.productPreviewItem(quantifiedProduct.product, quantifiedProduct.quantity, quantifiedProductPrice.totalPrice.priceWithVat, quantifiedProduct.isSaleItem) }}
                    {% endfor %}
                </ul>
                <ul class="list-cart-preview">
                    {% set orderGiftProduct = orderPreview.orderGiftProduct %}
                    {% if orderGiftProduct is not null or orderPreview.gifts is not empty %}
                        <li class="list-cart-preview__title">{{ 'Dárek k vaší objednávce:'|trans }}</li>
                    {% endif %}
                    {% if orderGiftProduct is not null %}
                        {{ _self.productPreviewItem(orderGiftProduct, 1, orderGiftProductPrice) }}
                    {% endif %}
                    {% if orderPreview.gifts is not empty %}
                        {% for gift in orderPreview.gifts %}
                            {{ _self.productPreviewItem(gift.product, gift.quantity, gift.totalPrice) }}
                        {% endfor %}
                    {% endif %}
                </ul>
            {% endif %}

            <table id="js-order-preview-fees" class="table-cart-preview">
                <tbody>
                    {% if orderStep == "1" %}
                        <tr class="table-cart-preview__row">
                            <td class="table-cart-preview__cell">
                                {{ 'Za zboží bez slevy'|trans }}
                            </td>
                            <td class="table-cart-preview__cell table-cart-preview__cell--price">
                                {{ orderPreview.totalPrice.priceWithVat|price }}
                            </td>
                        </tr>
                    {% endif %}
                    {% if orderPreview.activeOrderDiscountLevel is not null %}
                        <tr class="table-cart-preview__row">
                            <td class="table-cart-preview__cell">
                                {{ 'Sleva na celý nákup %percent% %'|trans({'%percent%': orderPreview.activeOrderDiscountLevel.discountPercent}) }}
                            </td>
                            <td class="table-cart-preview__cell table-cart-preview__cell--price  table-cart-preview__cell--important">
                                - {{ orderPreview.totalDiscount.priceWithVat|price }}
                            </td>
                        </tr>
                    {% endif %}
                    {% set promocodeActive = false %}
                    {% for promoCodeId, promoCode in orderPreview.promoCodesIndexedById %}
                        {% if orderPreview.getTotalItemDiscountsIndexedByPromoCodeId[promoCodeId] is defined %}
                            {% set promocodeActive = true %}
                            <tr class="table-cart-preview__row">
                                <td class="table-cart-preview__cell">
                                    {{ 'Sleva'|trans }}
                                    <span class="next-line"></span> {{ '(kód %code%)'|trans({ '%code%': promoCode.code }) }}
                                </td>
                                <td class="table-cart-preview__cell table-cart-preview__cell--price  table-cart-preview__cell--important">
                                    - {{ orderPreview.getTotalItemDiscountsIndexedByPromoCodeId[promoCodeId].priceWithVat|price }}
                                </td>
                            </tr>
                        {% endif %}
                    {% endfor %}

                    {% if orderPreview.transport is not empty %}
                        <tr class="table-cart-preview__row">
                            <td class="table-cart-preview__cell">
                                {{ 'Doprava'|trans }} - {{ orderPreview.transport.name }}
                            </td>
                            <td class="table-cart-preview__cell table-cart-preview__cell--price">
                                {{ orderPreview.transportPrice.priceWithVat|priceText }}
                            </td>
                        </tr>
                    {% endif %}

                    {% if orderPreview.payment is not empty %}
                        <tr class="table-cart-preview__row">
                            <td class="table-cart-preview__cell">
                                {{ 'Platba'|trans }} - {{ orderPreview.payment.name }}
                            </td>
                            <td class="table-cart-preview__cell table-cart-preview__cell--price">
                                {{ orderPreview.paymentPrice.priceWithVat|priceText }}
                            </td>
                        </tr>
                    {% endif %}

                    {% if orderPreview.roundingPrice is not empty %}
                        <tr class="table-cart-preview__row">
                            <td class="table-cart-preview__cell">
                                {{ 'Rounding'|trans }}
                            </td>
                            <td class="table-cart-preview__cell table-cart-preview__cell--price">
                                {{ orderPreview.roundingPrice.priceWithVat|price }}
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>

            <div id="js-order-preview-total-price" class="table-cart-preview table-cart-preview--without-gap">
                <div class="table-cart-preview__total">
                    {% if orderPreview.activeOrderDiscountLevel is not null or promocodeActive %}
                        <span class="table-cart-preview__total__discount js-not-implemented-yet">Ušetříte 3 175 Kč</span>
                    {% endif %} 
                    <span class="table-cart-preview__total__price-primary {% if orderPreview.activeOrderDiscountLevel is not null or promocodeActive %}table-cart-preview__total__price-primary--colored{% endif %}">
                        {{ orderPreview.totalPrice.priceWithVat|price }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="box-preview__action">
        <div class="in-action">
            <div class="in-action__back">
                {% if orderStep == 1 %}
                    <a href="{{ url('front_homepage') }}" class="in-action__link">
                        <i class="in-action__link__icon svg svg-triangle"></i>
                        <span class="in-action__link__text">{{ 'Zpět do e-shopu'|trans }}</span>
                    </a>
                {% elseif orderStep == 2 %}
                    <a href="{{ url('front_cart') }}" class="in-action__link">
                        {{ 'Zpět do košíku'|trans }}
                    </a>
                {% elseif orderStep == 3 %}
                    <button type="submit" name="flow_order_transition" value="back" class="in-action__link js-no-validate-button">
                        <span>
                            {{ 'Zpět'|trans }}
                        </span>
                    </button>
                {% endif %}
            </div>

            {% if orderStep == 1 %}
                {% if isFreeTransportAndPaymentActive %}
                    <div class="in-action__free-transport">
                        {% if isPaymentAndTransportFree %}
                            {{ 'Výborně, od nás máte'|trans }}&nbsp;<span class="in-action__free-transport__colored-text">{{ 'dopravu zdarma!'|trans }}</span>
                        {% else %}
                            {{ 'Nakupte ještě za'|trans }}&nbsp;<span class="in-free-transport__title__price">{{ remainingPriceWithVat|price }}</span>&nbsp;{{ 'a máte'|trans }}
                            <br> <span class="in-free-transport__title__important">{{ 'dopravu zdarma!'|trans }}</span>
                        {% endif %}
                    </div>
                {% endif %}
            {% endif %}

            {% if orderStep > 2 %}
                <div class="box-preview__conditions">
                    {{ 'Kliknutím na tlačítko Odeslat objednávku'|trans }}<br>
                    {{ 'souhlasím s '|trans }}
                    {% if termsAndConditionsArticle is not null %}
                        <a href="{{ url('front_article_detail', { id: termsAndConditionsArticle.id }) }}" target="_blank" class="box-preview__conditions__link">
                            <span>
                                {{ 'obchodními podmínkami'|trans }}
                            </span>
                        </a>
                    {% else %}
                        {{ 'obchodními podmínkami'|trans }}
                    {% endif %}
                    {{ ' e-shopu a souhlasím se zpracováním'|trans}}
                    {% if privacyPolicyArticle is not null %}
                        <a href="{{ url('front_article_detail', { id: privacyPolicyArticle.id }) }}" target="_blank" class="box-preview__conditions__link">
                            <span>
                                {{ 'osobních údajů'|trans }}
                            </span>
                        </a>
                    {% else %}
                        {{ 'osobních údajů'|trans }}
                    {% endif %}
                </div>
            {% endif %}

            {% if orderPreview.quantifiedProducts > 0 and renderSubmitButton %}
                {% if orderStep == 1 %}
                    {% set continueButtonText = 'Vybrat způsob dopravy'|trans %}
                {% elseif orderStep == 2 %}
                    {% set continueButtonText = 'Vyplnit dodací údaje'|trans %}
                {% else %}
                    {% set continueButtonText = 'Odeslat objednávku'|trans %}
                {% endif %}
                <button type="submit" id="{{ formSubmit.vars.id }}" name="{{ formSubmit.vars.full_name }}" class="btn btn--success btn--large">
                    {{ continueButtonText }}
                </button>
                {% do formSubmit.setRendered %}
            {% endif %}
        </div>
    </div>
</div>
