{% extends '@ShopsysShop/Front/Layout/layoutWithoutPanel.html.twig' %}
{% import '@ShopsysShop/Front/Content/Product/productListMacro.html.twig' as productList %}
{% import '@ShopsysShop/Front/Inline/Product/distinguishingParameterMacro.html.twig' as distinguishingParameter %}

{% block meta_robots -%}
    <meta name="robots" content="noindex, follow">
{% endblock %}

{% block title %}
    {{ 'Cart'|trans }}
{% endblock %}

{% block breadcrumb %}
{% endblock %}

{% block infoRow %}
{% endblock %}

{% block main_content %}
    <div class="web__line">
        <div class="web__container web__container--big-padding">
            <h1 class="in-title in-title--big in-title--center in-title--dark">
                {{ 'Nákupní košík'|trans }}
            </h1>

            {% if cart is not null %}
                {{ form_start(form, { attr: { class: 'js-no-validate js-cart-form' }}) }}
                    <div class="box-order">
                        <div class="box-order__info">
                            <div class="box-order__info__top">
                                {% include '@ShopsysShop/Front/Inline/OrderProgress/index.html.twig' with {step: '1'} only %}
                            </div>
                            {{ form_errors(form) }}
                            <div class="table-cart js-cart">
                                {% for index, cartItem in cartItems %}
                                    {% set cartItemPrice = cartItemPrices[index] %}
                                    <div class="table-cart__row js-cart-item">
                                        <div class="table-cart__row__left">
                                            <div class="table-cart__cell__number">
                                                <span class="table-cart__cell__number__text">
                                                    {{ loop.index }}
                                                </span>
                                            </div>
                                            <div class="table-cart__cell__image">
                                                <a href="{{ url('front_product_detail', {id: cartItem.product.id}) }}" title="{{ cartItem.product.name }}">
                                                    {{ image(cartItem.product.productForCreatingImageAccordingToVariant, { size: 'biggerThumbnail', lazy: true }) }}
                                                </a>
                                            </div>
                                            <div class="table-cart__cell__name js-cart-item-name">
                                                <a class="table-cart__cell__name__title" href="{{ url('front_product_detail', {id: cartItem.product.id}) }}" title="{{ cartItem.name }}">
                                                    {{ cartItem.name }}
                                                </a>
                                                {{ distinguishingParameter.writeParameters(cartItem.product, 'table-cart__cell__name__text') }}
                                            </div>
                                        </div>
                                        <div class="table-cart__row__right">
                                            <div class="table-cart__cell__spinbox">
                                                <span class="form-input-spinbox js-spinbox">
                                                    {{ form_widget(form.quantities[cartItem.id], { attr: { class: 'form-input-spinbox__input input-no-style js-spinbox-input', 'data-spinbox-min': 1}}) }}
                                                    <label class="form-input-spinbox__label">{{ 'Kusů'|trans }}</label>
                                                    <div class="btn-no-style form-input-spinbox__btn js-spinbox-plus"><i class="svg svg-plus"></i></div>
                                                    <div class="btn-no-style form-input-spinbox__btn form-input-spinbox__btn--minus js-spinbox-minus"><i class="svg svg-minus"></i></div>
                                                </span>
                                                <a
                                                    href="{{ url('front_cart_delete', {cartItemId: cartItem.id, _token: csrf_token('front_cart_delete_' ~ cartItem.id)}) }}"
                                                    class="table-cart__cell__spinbox__link js-cart-item-remove-button"
                                                >
                                                    {{ 'Odstranit'|trans }}
                                                </a>
                                            </div>
                                            <div class="table-cart__cell__price js-cart-item-total-price">
                                                {% if cartItemPrice.unitPrice.isActionPrice %}
                                                    <span class="table-cart__cell__price__line-through">{{ cartItemPrice.unitPrice.defaultProductPrice.priceWithVat|price }}</span>
                                                {% endif %}
                                                <div class="table-cart__cell__price__primary">
                                                    {{ cartItemPrice.unitPrice.priceWithVat|price }}
                                                </div>
                                            </div>
                                            {% if promoCode is not null %}
                                                <div class="table-cart__cell__discount">
                                                    {% if cartItemDiscounts[index] is not null %}
                                                        &nbsp;{{ promoCode.code }}
                                                        {{ cartItemDiscounts[index].priceWithVat|price }}
                                                    {% endif %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>

                                    {% if cartItem.product.id in cartGiftsByProductId|keys %}
                                        {% set cartItemGift = cartGiftsByProductId[cartItem.product.id] %}
                                        <ul>
                                            {% for giftVariant in cartItemGift %}
                                                <li>
                                                    {{ form_widget(form.chosenGifts[cartItem.product.id][giftVariant.gift.id], { attr: { class: 'js-take-gift' } }) }}
                                                    {{ 'Chcete dárek' }} {{ giftVariant.gift.name }} {{ 'v hodnotě' }} {{ getProductSellingPrice(giftVariant.gift).priceWithVat|price }} {{ 'za ' }} {{ giftVariant.price|price }} {{ '?' }}
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        {% do form.chosenGifts.setRendered %}
                                    {% endif %}

                                {% endfor %}
                            </div>

                            {% if isFreeTransportAndPaymentActive %}
                                {% if isPaymentAndTransportFree %}
                                    <div class="in-free-transport in-free-transport--dark">
                                        <span class="in-free-transport__title__important">{{ 'Máte dopravu zdarma!'|trans }}</span>
                                    </div>
                                {% else %}
                                    <div class="in-free-transport in-free-transport--dark">
                                        <div class="in-free-transport__title">
                                            {{ 'Nakupte ještě za '|trans }} <span class="in-free-transport__title__price">{{ remainingPriceWithVat|price }}</span>&nbsp;{{ 'a'|trans }}<br>
                                            {{ 'máte'|trans }} <span class="in-free-transport__title__important">{{ 'dopravu zdarma!'|trans }}</span>
                                        </div>
                                        <div class="in-free-transport__pipe">
                                            <div class="in-free-transport__pipe__line" style="width: {{ percentsForFreeTransportAndPayment }}%;"></div>
                                        </div>
                                    </div>
                                {% endif %}
                            {% endif %}

                            <div class="box-order__additional js-not-implemented-yet">
                                <div class="box-order__additional__title">
                                    {{ 'Přihoďte si k nákupu'|trans }}
                                </div>
                                {# TODO PRG: add additional products to list #}
                                {#{ productList.horizontalList(cartItems, null, "list-basket-additionals", 'h3', 'basket-additionals') }#}
                            </div>
                        </div>
                        <div id="js-order-preview" class="box-order__cart" data-url="{{ url('front_order_preview') }}">
                            {{ render(controller('ShopsysShopBundle:Front/Order:preview', {
                                orderStep: "1",
                                formSubmit: form.submit
                            })) }}
                        </div>
                    </div>
                {{ form_end(form) }}
            {% else %}
                <div class="box-cart-empty">
                    <div class="box-cart-empty__image">
                        <img src="{{ asset('assets/frontend/images/empty-cart.png') }}" alt="{{ 'Empty cart'|trans }}">
                    </div>
                    <div class="box-cart-empty__text">
                        {{ 'Your cart is unfortunately empty. To create order, you have to <a href="%url%">choose</a> some product first'|transHtml({ '%url%': url('front_homepage') }) }}

                        <div class="box-cart-empty__text__button">
                            <a href="{{url('front_homepage') }}" class="btn">
                                {{ 'Back to buying'|trans }}
                            </a>
                        </div>
                    </div>
                </div>

            {% endif %}
        </div>
    </div>
    <div class="web__line">
        <div class="web__container web__container--dark web__container--big-padding">
            {% include '@ShopsysShop/Front/Content/Motto/line.html.twig' %}
        </div>
    </div>
{% endblock %}
